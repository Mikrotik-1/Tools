<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MikroTik Analyzer | Ù…Ø­Ù„Ù„ Ø§Ù„Ù…ÙŠÙƒØ±Ùˆ Ø§Ù„Ù…Ø­Ù„ÙŠ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #10b981;
            --accent: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --darker: #0f172a;
            --light: #f8fafc;
            --gray: #64748b;
            --gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
            --shadow: 0 20px 40px rgba(99,102,241,0.12);
            --radius: 16px;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { background:#0f172a; color:#e2e8f0; font-family:'Tajawal',sans-serif; min-height:100vh; }
        body.en { font-family:'Poppins',sans-serif; }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg,#1e293b,#0f172a);
            padding: 20px 30px;
            border-bottom: 1px solid rgba(99,102,241,0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-logo { display:flex; align-items:center; gap:12px; }
        .logo-icon { background:var(--gradient); width:46px; height:46px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:20px; color:white; }
        .logo-text { font-size:1.3rem; font-weight:800; color:white; }
        .logo-sub { font-size:0.75rem; color:#64748b; }
        .header-actions { display:flex; align-items:center; gap:10px; }
        .lang-toggle { background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#94a3b8; padding:6px 16px; border-radius:20px; cursor:pointer; font-size:13px; font-weight:600; transition:all 0.3s; }
        .lang-toggle:hover { background:var(--primary); color:white; }
        .connection-dot { width:10px; height:10px; border-radius:50%; background:#64748b; display:inline-block; margin-left:6px; }
        .connection-dot.connected { background:#10b981; box-shadow:0 0 8px #10b981; animation:dotPulse 2s infinite; }
        .connection-dot.error { background:#ef4444; }
        @keyframes dotPulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

        /* ===== MAIN LAYOUT ===== */
        .main { max-width:1400px; margin:0 auto; padding:25px 20px; }

        /* ===== CONNECTION PANEL ===== */
        .connect-panel {
            background: linear-gradient(135deg,rgba(99,102,241,0.08),rgba(139,92,246,0.05));
            border: 1.5px solid rgba(99,102,241,0.25);
            border-radius: var(--radius);
            padding: 28px;
            margin-bottom: 25px;
        }
        .connect-title { font-size:1.3rem; font-weight:800; color:white; margin-bottom:5px; display:flex; align-items:center; gap:10px; }
        .connect-sub { color:#64748b; font-size:0.9rem; margin-bottom:22px; }
        .connect-form { display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:15px; align-items:end; }
        .field-group { display:flex; flex-direction:column; gap:7px; }
        .field-label { color:#94a3b8; font-size:0.82rem; font-weight:600; display:flex; align-items:center; gap:5px; }
        .field-label i { color:var(--primary-light); font-size:11px; }
        .field-input {
            background: rgba(255,255,255,0.06);
            border: 1.5px solid rgba(255,255,255,0.1);
            color: white;
            padding: 11px 16px;
            border-radius: 12px;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.3s;
            font-family: inherit;
        }
        .field-input:focus { border-color:var(--primary); background:rgba(99,102,241,0.1); box-shadow:0 0 0 3px rgba(99,102,241,0.15); }
        .field-input::placeholder { color:#334155; }
        .connect-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 11px 26px;
            border-radius: 12px;
            font-weight:700;
            font-size:0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            font-family: inherit;
        }
        .connect-btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(99,102,241,0.4); }
        .connect-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
        .disconnect-btn {
            background: rgba(239,68,68,0.15);
            border: 1px solid rgba(239,68,68,0.3);
            color: #fca5a5;
            padding: 11px 20px;
            border-radius: 12px;
            font-weight:600;
            cursor:pointer;
            transition:all 0.3s;
            font-size:0.9rem;
            font-family:inherit;
            display:none;
        }
        .disconnect-btn:hover { background:rgba(239,68,68,0.3); }

        /* Status bar */
        .status-bar {
            margin-top:15px;
            padding:12px 18px;
            border-radius:10px;
            font-size:0.9rem;
            font-weight:600;
            display:none;
            align-items:center;
            gap:10px;
        }
        .status-bar.connecting { background:rgba(99,102,241,0.1); border:1px solid rgba(99,102,241,0.25); color:#a5b4fc; display:flex; }
        .status-bar.success { background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.25); color:#6ee7b7; display:flex; }
        .status-bar.error { background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.25); color:#fca5a5; display:flex; }

        /* Progress */
        .fetch-progress { margin-top:15px; display:none; }
        .progress-bar { background:rgba(255,255,255,0.05); border-radius:20px; height:6px; overflow:hidden; margin-top:8px; }
        .progress-fill { height:100%; background:var(--gradient); border-radius:20px; transition:width 0.4s ease; width:0%; }
        .progress-steps { display:flex; justify-content:space-between; margin-top:8px; }
        .progress-step { font-size:0.75rem; color:#475569; transition:color 0.3s; }
        .progress-step.done { color:#10b981; }
        .progress-step.active { color:#a5b4fc; }

        /* ===== DASHBOARD ===== */
        #dashboard { display:none; }

        /* Refresh bar */
        .refresh-bar {
            display:flex; align-items:center; justify-content:space-between;
            background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06);
            border-radius:12px; padding:12px 20px; margin-bottom:20px; flex-wrap:wrap; gap:10px;
        }
        .router-info { display:flex; align-items:center; gap:15px; flex-wrap:wrap; }
        .router-badge { background:rgba(99,102,241,0.15); border:1px solid rgba(99,102,241,0.25); color:#a5b4fc; padding:4px 14px; border-radius:20px; font-size:0.82rem; font-weight:600; }
        .refresh-actions { display:flex; gap:8px; align-items:center; }
        .refresh-btn { background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.2); color:#6ee7b7; padding:7px 18px; border-radius:20px; cursor:pointer; font-size:0.85rem; font-weight:600; transition:all 0.3s; font-family:inherit; display:flex; align-items:center; gap:6px; }
        .refresh-btn:hover { background:rgba(16,185,129,0.2); }
        .last-update { color:#475569; font-size:0.8rem; }

        /* ===== TABS ===== */
        .tabs { display:flex; gap:5px; background:rgba(255,255,255,0.03); padding:5px; border-radius:14px; border:1px solid rgba(255,255,255,0.06); margin-bottom:25px; flex-wrap:wrap; }
        .tab-btn { flex:1; min-width:100px; padding:10px 15px; border:none; border-radius:10px; font-weight:600; font-size:0.85rem; cursor:pointer; transition:all 0.3s; background:transparent; color:#64748b; display:flex; align-items:center; justify-content:center; gap:6px; font-family:inherit; }
        .tab-btn:hover { color:#94a3b8; background:rgba(255,255,255,0.04); }
        .tab-btn.active { background:var(--gradient); color:white; box-shadow:0 4px 15px rgba(99,102,241,0.3); }
        .tab-badge { background:rgba(255,255,255,0.2); padding:1px 7px; border-radius:10px; font-size:0.75rem; }
        .tab-panel { display:none; }
        .tab-panel.active { display:block; }

        /* ===== CARDS ===== */
        .card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: var(--radius);
            padding: 22px;
            margin-bottom: 20px;
        }
        .card-title { font-size:1rem; font-weight:700; color:white; margin-bottom:18px; display:flex; align-items:center; gap:10px; }
        .card-title i { color:var(--primary-light); }

        /* Stats grid */
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:15px; margin-bottom:20px; }
        .stat-box {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius:14px; padding:18px; text-align:center;
        }
        .stat-box i { font-size:1.8rem; margin-bottom:8px; }
        .stat-val { font-size:1.8rem; font-weight:900; line-height:1.2; }
        .stat-lbl { font-size:0.8rem; color:#64748b; margin-top:4px; }
        .stat-box.green i,.stat-box.green .stat-val { color:#10b981; }
        .stat-box.blue i,.stat-box.blue .stat-val { color:#3b82f6; }
        .stat-box.yellow i,.stat-box.yellow .stat-val { color:#f59e0b; }
        .stat-box.red i,.stat-box.red .stat-val { color:#ef4444; }
        .stat-box.purple i,.stat-box.purple .stat-val { color:#8b5cf6; }
        .stat-box.pink i,.stat-box.pink .stat-val { color:#ec4899; }

        /* Progress bar (for CPU/RAM) */
        .usage-bar { background:rgba(255,255,255,0.06); border-radius:20px; height:8px; margin-top:10px; overflow:hidden; }
        .usage-fill { height:100%; border-radius:20px; transition:width 1s ease; }
        .usage-fill.green { background:linear-gradient(90deg,#10b981,#059669); }
        .usage-fill.yellow { background:linear-gradient(90deg,#f59e0b,#d97706); }
        .usage-fill.red { background:linear-gradient(90deg,#ef4444,#dc2626); }

        /* Table */
        .data-table { width:100%; border-collapse:collapse; font-size:0.88rem; }
        .data-table th { background:rgba(99,102,241,0.1); color:#a5b4fc; padding:12px 15px; text-align:right; font-weight:700; border-bottom:1px solid rgba(255,255,255,0.06); }
        .data-table td { padding:12px 15px; border-bottom:1px solid rgba(255,255,255,0.04); color:#cbd5e1; vertical-align:middle; }
        .data-table tr:hover td { background:rgba(255,255,255,0.03); }
        .table-wrap { overflow-x:auto; border-radius:12px; border:1px solid rgba(255,255,255,0.06); max-height:400px; overflow-y:auto; }

        /* Badges */
        .badge { display:inline-block; padding:3px 12px; border-radius:20px; font-size:0.78rem; font-weight:700; }
        .badge-green { background:rgba(16,185,129,0.15); color:#6ee7b7; border:1px solid rgba(16,185,129,0.2); }
        .badge-red { background:rgba(239,68,68,0.15); color:#fca5a5; border:1px solid rgba(239,68,68,0.2); }
        .badge-yellow { background:rgba(245,158,11,0.15); color:#fcd34d; border:1px solid rgba(245,158,11,0.2); }
        .badge-blue { background:rgba(59,130,246,0.15); color:#93c5fd; border:1px solid rgba(59,130,246,0.2); }
        .badge-purple { background:rgba(139,92,246,0.15); color:#c4b5fd; border:1px solid rgba(139,92,246,0.2); }

        /* IP tag */
        .ip-tag { background:rgba(99,102,241,0.1); color:#a5b4fc; padding:3px 10px; border-radius:8px; font-family:monospace; font-size:0.82rem; border:1px solid rgba(99,102,241,0.15); display:inline-block; }

        /* Log area */
        .log-area { background:#0a0f1a; border-radius:12px; padding:18px; font-family:monospace; font-size:0.82rem; line-height:1.9; max-height:500px; overflow-y:auto; border:1px solid rgba(255,255,255,0.05); direction:ltr; text-align:left; }
        .log-critical { color:#fca5a5; }
        .log-error { color:#fdba74; }
        .log-warning { color:#fde68a; }
        .log-info { color:#93c5fd; }
        .log-time { color:#475569; margin-left:10px; }
        .log-source { color:#8b5cf6; margin-left:8px; }

        /* Charts */
        .charts-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:20px; margin-bottom:20px; }
        .chart-box { background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.07); border-radius:14px; padding:18px; }
        .chart-box h5 { font-size:0.9rem; color:#94a3b8; margin-bottom:15px; display:flex; align-items:center; gap:8px; }
        .chart-box h5 i { color:var(--primary-light); }
        .chart-wrap { height:220px; position:relative; }

        /* Filter bar */
        .filter-bar { display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap; align-items:center; }
        .filter-input { background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08); color:white; padding:8px 15px; border-radius:20px; font-size:0.85rem; outline:none; font-family:inherit; }
        .filter-input:focus { border-color:var(--primary); }
        .filter-select { background:#1e293b; border:1px solid rgba(255,255,255,0.08); color:#94a3b8; padding:8px 15px; border-radius:20px; font-size:0.85rem; outline:none; cursor:pointer; font-family:inherit; }

        /* Summary alert */
        .summary-alert { border-radius:14px; padding:16px 20px; margin-bottom:20px; display:flex; align-items:center; gap:12px; font-weight:600; font-size:1rem; }
        .summary-alert.danger { background:rgba(239,68,68,0.1); border:1.5px solid rgba(239,68,68,0.25); color:#fca5a5; }
        .summary-alert.warning { background:rgba(245,158,11,0.1); border:1.5px solid rgba(245,158,11,0.25); color:#fcd34d; }
        .summary-alert.good { background:rgba(16,185,129,0.1); border:1.5px solid rgba(16,185,129,0.25); color:#6ee7b7; }

        /* Spinner */
        @keyframes spin { to{transform:rotate(360deg)} }
        .spin { animation:spin 0.8s linear infinite; display:inline-block; }

        /* Responsive */
        @media(max-width:900px) {
            .connect-form { grid-template-columns:1fr 1fr; }
            .header { padding:15px 20px; }
        }
        @media(max-width:600px) {
            .connect-form { grid-template-columns:1fr; }
            .tabs { gap:3px; }
            .tab-btn { font-size:0.78rem; padding:8px 10px; }
            .stats-grid { grid-template-columns:repeat(2,1fr); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width:6px; height:6px; }
        ::-webkit-scrollbar-track { background:rgba(255,255,255,0.02); }
        ::-webkit-scrollbar-thumb { background:rgba(99,102,241,0.3); border-radius:3px; }
        ::-webkit-scrollbar-thumb:hover { background:rgba(99,102,241,0.5); }

        /* Toast */
        .toast { position:fixed; bottom:25px; left:50%; transform:translateX(-50%); background:#1e293b; color:white; padding:12px 25px; border-radius:30px; font-weight:600; box-shadow:0 10px 30px rgba(0,0,0,0.4); z-index:9999; border:1px solid rgba(255,255,255,0.1); white-space:nowrap; }
    </style>
</head>
<body class="ar rtl">

<!-- HEADER -->
<header class="header">
    <div class="header-logo">
        <div class="logo-icon"><i class="fas fa-microchip"></i></div>
        <div>
            <div class="logo-text">MikroTik Analyzer</div>
            <div class="logo-sub" data-i18n="logo_sub">Ù…Ø­Ù„Ù„ Ø§Ù„Ù…ÙŠÙƒØ±Ùˆ Ø§Ù„Ù…Ø­Ù„ÙŠ â€” Ø´ØºÙ‘Ù„Ù‡ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©</div>
        </div>
    </div>
    <div class="header-actions">
        <span id="connDot" class="connection-dot"></span>
        <span id="connLabel" style="color:#64748b;font-size:0.85rem;" data-i18n="not_connected">ØºÙŠØ± Ù…ØªØµÙ„</span>
        <button class="lang-toggle" onclick="toggleLang()">EN / AR</button>
    </div>
</header>

<div class="main">

    <!-- CONNECTION PANEL -->
    <div class="connect-panel">
        <div class="connect-title">
            <i class="fas fa-plug" style="color:#10b981;"></i>
            <span data-i18n="connect_title">Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø±Ø§ÙˆØªØ±</span>
        </div>
        <div class="connect-sub" data-i18n="connect_sub">Ø§ÙƒØªØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙŠÙƒØ±Ùˆ ÙˆØ§Ø¶ØºØ· Ø§ØªØµÙ„ â€” Ù‡Ù†Ø¬ÙŠØ¨ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ</div>

        <div class="connect-form">
            <div class="field-group">
                <label class="field-label"><i class="fas fa-server"></i> <span data-i18n="lbl_ip">IP Ø§Ù„Ø±Ø§ÙˆØªØ±</span></label>
                <input class="field-input" id="fIP" type="text" placeholder="192.168.1.1" dir="ltr" value="192.168.1.1">
            </div>
            <div class="field-group">
                <label class="field-label"><i class="fas fa-user"></i> <span data-i18n="lbl_user">Ø§Ù„ÙŠÙˆØ²Ø±</span></label>
                <input class="field-input" id="fUser" type="text" placeholder="admin" dir="ltr" value="admin">
            </div>
            <div class="field-group">
                <label class="field-label"><i class="fas fa-lock"></i> <span data-i18n="lbl_pass">Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯</span></label>
                <input class="field-input" id="fPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" dir="ltr">
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="connect-btn" id="btnConnect" onclick="doConnect()">
                    <i class="fas fa-bolt"></i>
                    <span data-i18n="btn_connect">Ø§ØªØµÙ„</span>
                </button>
                <button class="disconnect-btn" id="btnDisconnect" onclick="doDisconnect()" data-i18n="btn_disconnect">Ù‚Ø·Ø¹</button>
            </div>
        </div>

        <!-- Status -->
        <div class="status-bar" id="statusBar"></div>

        <!-- Progress -->
        <div class="fetch-progress" id="fetchProgress">
            <div style="color:#64748b;font-size:0.82rem;" id="progressLabel">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            <div class="progress-steps">
                <span class="progress-step" id="ps1" data-i18n="ps_system">âš™ï¸ Ø§Ù„Ù†Ø¸Ø§Ù…</span>
                <span class="progress-step" id="ps2" data-i18n="ps_iface">ğŸŒ Ø§Ù„Ø¥Ù†ØªØ±ÙÙŠØ³Ø§Øª</span>
                <span class="progress-step" id="ps3" data-i18n="ps_users">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                <span class="progress-step" id="ps4" data-i18n="ps_logs">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</span>
                <span class="progress-step" id="ps5" data-i18n="ps_fw">ğŸ”¥ Ø§Ù„ÙØ§ÙŠØ±ÙˆÙˆÙ„</span>
            </div>
        </div>

        <!-- Setup hint -->
        <div style="margin-top:15px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:10px;padding:12px 16px;color:#fcd34d;font-size:0.85rem;">
            <i class="fas fa-info-circle" style="margin-left:7px;"></i>
            <span data-i18n="setup_hint">ØªØ£ÙƒØ¯ Ø¥Ù† www service Ù…ÙØ¹Ù‘Ù„ ÙÙŠ Ø§Ù„Ù…ÙŠÙƒØ±Ùˆ: </span>
            <code style="background:rgba(0,0,0,0.3);padding:2px 8px;border-radius:6px;font-family:monospace;">/ip service enable www</code>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard">

        <!-- Refresh bar -->
        <div class="refresh-bar">
            <div class="router-info">
                <span style="color:white;font-weight:700;" id="routerName">Router</span>
                <span class="router-badge" id="routerVersion">RouterOS</span>
                <span class="router-badge" style="background:rgba(16,185,129,0.1);border-color:rgba(16,185,129,0.2);color:#6ee7b7;" id="routerUptime">Uptime: --</span>
            </div>
            <div class="refresh-actions">
                <span class="last-update" id="lastUpdate"></span>
                <button class="refresh-btn" onclick="refreshAll()"><i class="fas fa-sync-alt" id="refreshIcon"></i> <span data-i18n="btn_refresh">ØªØ­Ø¯ÙŠØ«</span></button>
            </div>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('overview')" id="tab-overview">
                <i class="fas fa-tachometer-alt"></i> <span data-i18n="tab_overview">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</span>
            </button>
            <button class="tab-btn" onclick="showTab('interfaces')" id="tab-interfaces">
                <i class="fas fa-network-wired"></i> <span data-i18n="tab_iface">Ø§Ù„Ø¥Ù†ØªØ±ÙÙŠØ³Ø§Øª</span>
                <span class="tab-badge" id="badgeIface">0</span>
            </button>
            <button class="tab-btn" onclick="showTab('users')" id="tab-users">
                <i class="fas fa-users"></i> <span data-i18n="tab_users">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                <span class="tab-badge" id="badgeUsers">0</span>
            </button>
            <button class="tab-btn" onclick="showTab('logs')" id="tab-logs">
                <i class="fas fa-scroll"></i> <span data-i18n="tab_logs">Ø§Ù„Ø³Ø¬Ù„Ø§Øª</span>
                <span class="tab-badge" id="badgeLogs">0</span>
            </button>
            <button class="tab-btn" onclick="showTab('firewall')" id="tab-firewall">
                <i class="fas fa-fire"></i> <span data-i18n="tab_fw">Ø§Ù„ÙØ§ÙŠØ±ÙˆÙˆÙ„</span>
                <span class="tab-badge" id="badgeFw">0</span>
            </button>
            <button class="tab-btn" onclick="showTab('ip')" id="tab-ip">
                <i class="fas fa-sitemap"></i> <span data-i18n="tab_ip">Ø¹Ù†Ø§ÙˆÙŠÙ† IP</span>
            </button>
        </div>

        <!-- TAB: OVERVIEW -->
        <div class="tab-panel active" id="panel-overview">
            <div id="summaryAlert"></div>
            <div class="stats-grid" id="overviewStats"></div>
            <div class="charts-row" id="overviewCharts"></div>
            <div class="card" id="resourceCard"></div>
        </div>

        <!-- TAB: INTERFACES -->
        <div class="tab-panel" id="panel-interfaces">
            <div class="card">
                <div class="card-title"><i class="fas fa-network-wired"></i> <span data-i18n="iface_title">Ø§Ù„Ø¥Ù†ØªØ±ÙÙŠØ³Ø§Øª</span></div>
                <div class="table-wrap"><table class="data-table" id="ifaceTable"></table></div>
            </div>
        </div>

        <!-- TAB: USERS -->
        <div class="tab-panel" id="panel-users">
            <div class="card">
                <div class="card-title"><i class="fas fa-wifi"></i> <span data-i18n="hs_users_title">Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Hotspot</span></div>
                <div class="filter-bar">
                    <input class="filter-input" id="hsSearch" placeholder="ğŸ” Ø¨Ø­Ø«..." oninput="filterHS()">
                </div>
                <div class="table-wrap"><table class="data-table" id="hsTable"></table></div>
            </div>
            <div class="card">
                <div class="card-title"><i class="fas fa-plug"></i> <span data-i18n="ppp_users_title">Ù…Ø³ØªØ®Ø¯Ù…ÙŠ PPP/VPN</span></div>
                <div class="table-wrap"><table class="data-table" id="pppTable"></table></div>
            </div>
            <div class="card">
                <div class="card-title"><i class="fas fa-list"></i> <span data-i18n="dhcp_title">Ø¹Ù…Ù„Ø§Ø¡ DHCP</span></div>
                <div class="table-wrap"><table class="data-table" id="dhcpTable"></table></div>
            </div>
        </div>

        <!-- TAB: LOGS -->
        <div class="tab-panel" id="panel-logs">
            <div id="logSummaryAlert"></div>
            <div class="stats-grid" id="logStats"></div>
            <div class="charts-row" id="logCharts"></div>
            <div class="card">
                <div class="card-title"><i class="fas fa-scroll"></i> <span data-i18n="logs_title">Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</span></div>
                <div class="filter-bar">
                    <input class="filter-input" id="logSearch" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª..." oninput="filterLogs()">
                    <select class="filter-select" id="logSevFilter" onchange="filterLogs()">
                        <option value="all" data-i18n="all_levels">ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</option>
                        <option value="critical">Critical</option>
                        <option value="error">Error</option>
                        <option value="warning">Warning</option>
                        <option value="info">Info</option>
                    </select>
                    <select class="filter-select" id="logTopicFilter" onchange="filterLogs()">
                        <option value="all" data-i18n="all_topics">ÙƒÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ø±</option>
                    </select>
                </div>
                <div class="log-area" id="logArea"></div>
            </div>
        </div>

        <!-- TAB: FIREWALL -->
        <div class="tab-panel" id="panel-firewall">
            <div class="card">
                <div class="card-title"><i class="fas fa-fire"></i> <span data-i18n="fw_filter_title">Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ÙØ§ÙŠØ±ÙˆÙˆÙ„ (Filter)</span></div>
                <div class="table-wrap"><table class="data-table" id="fwFilterTable"></table></div>
            </div>
            <div class="card">
                <div class="card-title"><i class="fas fa-random"></i> <span data-i18n="fw_nat_title">Ù‚ÙˆØ§Ø¹Ø¯ NAT</span></div>
                <div class="table-wrap"><table class="data-table" id="fwNatTable"></table></div>
            </div>
        </div>

        <!-- TAB: IP -->
        <div class="tab-panel" id="panel-ip">
            <div class="card">
                <div class="card-title"><i class="fas fa-sitemap"></i> <span data-i18n="ip_addr_title">Ø¹Ù†Ø§ÙˆÙŠÙ† IP</span></div>
                <div class="table-wrap"><table class="data-table" id="ipAddrTable"></table></div>
            </div>
            <div class="card">
                <div class="card-title"><i class="fas fa-route"></i> <span data-i18n="routes_title">Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡</span></div>
                <div class="table-wrap"><table class="data-table" id="routesTable"></table></div>
            </div>
        </div>

    </div><!-- end dashboard -->
</div><!-- end main -->

<script>
// =====================================================
//  STATE
// =====================================================
let CFG = { ip:'', user:'', pass:'' };
let DATA = {};
let charts = {};
let currentLang = localStorage.getItem('mtLang') || 'ar';

// =====================================================
//  LANG
// =====================================================
const T = {
    ar: {
        logo_sub:'Ù…Ø­Ù„Ù„ Ø§Ù„Ù…ÙŠÙƒØ±Ùˆ Ø§Ù„Ù…Ø­Ù„ÙŠ â€” Ø´ØºÙ‘Ù„Ù‡ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©',
        not_connected:'ØºÙŠØ± Ù…ØªØµÙ„', connected:'Ù…ØªØµÙ„',
        connect_title:'Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø±Ø§ÙˆØªØ±', connect_sub:'Ø§ÙƒØªØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙŠÙƒØ±Ùˆ ÙˆØ§Ø¶ØºØ· Ø§ØªØµÙ„',
        lbl_ip:'IP Ø§Ù„Ø±Ø§ÙˆØªØ±', lbl_user:'Ø§Ù„ÙŠÙˆØ²Ø±', lbl_pass:'Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯',
        btn_connect:'Ø§ØªØµÙ„', btn_disconnect:'Ù‚Ø·Ø¹', btn_refresh:'ØªØ­Ø¯ÙŠØ«',
        setup_hint:'ØªØ£ÙƒØ¯ Ø¥Ù† www service Ù…ÙØ¹Ù‘Ù„:',
        ps_system:'âš™ï¸ Ø§Ù„Ù†Ø¸Ø§Ù…', ps_iface:'ğŸŒ Ø§Ù„Ø¥Ù†ØªØ±ÙÙŠØ³Ø§Øª', ps_users:'ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', ps_logs:'ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª', ps_fw:'ğŸ”¥ Ø§Ù„ÙØ§ÙŠØ±ÙˆÙˆÙ„',
        tab_overview:'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©', tab_iface:'Ø§Ù„Ø¥Ù†ØªØ±ÙÙŠØ³Ø§Øª', tab_users:'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', tab_logs:'Ø§Ù„Ø³Ø¬Ù„Ø§Øª', tab_fw:'Ø§Ù„ÙØ§ÙŠØ±ÙˆÙˆÙ„', tab_ip:'Ø¹Ù†Ø§ÙˆÙŠÙ† IP',
        iface_title:'Ø§Ù„Ø¥Ù†ØªØ±ÙÙŠØ³Ø§Øª', hs_users_title:'Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Hotspot', ppp_users_title:'Ù…Ø³ØªØ®Ø¯Ù…ÙŠ PPP/VPN',
        dhcp_title:'Ø¹Ù…Ù„Ø§Ø¡ DHCP', logs_title:'Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©',
        fw_filter_title:'Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ÙØ§ÙŠØ±ÙˆÙˆÙ„', fw_nat_title:'Ù‚ÙˆØ§Ø¹Ø¯ NAT',
        ip_addr_title:'Ø¹Ù†Ø§ÙˆÙŠÙ† IP', routes_title:'Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡',
        all_levels:'ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª', all_topics:'ÙƒÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ø±',
        stat_cpu:'CPU', stat_mem:'Ø§Ù„Ø°Ø§ÙƒØ±Ø©', stat_disk:'Ø§Ù„Ø¯ÙŠØ³Ùƒ',
        stat_uptime:'ÙˆÙ‚Øª Ø§Ù„ØªØ´ØºÙŠÙ„', stat_version:'Ø§Ù„Ø¥ØµØ¯Ø§Ø±', stat_board:'Ø§Ù„Ø¨ÙˆØ±Ø¯',
        stat_hs:'Hotspot', stat_ppp:'PPP/VPN', stat_dhcp:'DHCP',
        stat_fw_rules:'Ù‚ÙˆØ§Ø¹Ø¯ FW', stat_total_logs:'Ø§Ù„Ø³Ø¬Ù„Ø§Øª',
        stat_errors:'Ø£Ø®Ø·Ø§Ø¡', stat_warnings:'ØªØ­Ø°ÙŠØ±Ø§Øª',
        iface_name:'Ø§Ù„Ø§Ø³Ù…', iface_type:'Ø§Ù„Ù†ÙˆØ¹', iface_status:'Ø§Ù„Ø­Ø§Ù„Ø©',
        iface_rx:'Ø§Ø³ØªÙ‚Ø¨Ø§Ù„', iface_tx:'Ø¥Ø±Ø³Ø§Ù„', iface_mac:'MAC',
        hs_user:'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', hs_ip:'IP', hs_mac:'MAC', hs_uptime:'Ù…Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„',
        hs_rx:'Ø§Ø³ØªÙ‚Ø¨Ø§Ù„', hs_tx:'Ø¥Ø±Ø³Ø§Ù„',
        log_time:'Ø§Ù„ÙˆÙ‚Øª', log_level:'Ø§Ù„Ù…Ø³ØªÙˆÙ‰', log_src:'Ø§Ù„Ù…ØµØ¯Ø±', log_msg:'Ø§Ù„Ø±Ø³Ø§Ù„Ø©',
        fw_chain:'Ø§Ù„Ø³Ù„Ø³Ù„Ø©', fw_action:'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡', fw_src:'Ø§Ù„Ù…ØµØ¯Ø±', fw_dst:'Ø§Ù„ÙˆØ¬Ù‡Ø©',
        fw_proto:'Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„', fw_comment:'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©',
        ip_addr:'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', ip_iface:'Ø§Ù„Ø¥Ù†ØªØ±ÙÙŠØ³', ip_network:'Ø§Ù„Ø´Ø¨ÙƒØ©',
        route_dst:'Ø§Ù„ÙˆØ¬Ù‡Ø©', route_gw:'Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©', route_iface:'Ø§Ù„Ø¥Ù†ØªØ±ÙÙŠØ³', route_dist:'Ø§Ù„Ù…Ø³Ø§ÙØ©',
        err_timeout:'Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§ØªØµØ§Ù„ â€” ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù€ IP ÙˆØ§Ù„Ø´Ø¨ÙƒØ©',
        err_auth:'Ø§Ù„ÙŠÙˆØ²Ø± Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ØºÙ„Ø·',
        err_cors:'ØªØ£ÙƒØ¯ Ø¥Ù†Ùƒ ÙØ§ØªØ­ Ø§Ù„ØµÙØ­Ø© ÙƒÙ€ file:// Ù…Ø´ Ù…Ù† Ø³ÙŠØ±ÙØ±',
        err_service:'www service Ù…Ø´ Ù…ÙØ¹Ù‘Ù„ â€” Ø´ØºÙ‘Ù„Ù‡ Ø¨Ø§Ù„Ø£Ù…Ø±: /ip service enable www',
        err_generic:'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„',
        status_connecting:'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...', status_fetching:'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...',
        status_success:'ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ…', status_disconnected:'ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„',
        good_network:'âœ… Ø§Ù„Ø´Ø¨ÙƒØ© ÙƒÙˆÙŠØ³Ø© â€” Ù…ÙÙŠØ´ Ù…Ø´Ø§ÙƒÙ„ ÙƒØ¨ÙŠØ±Ø©',
        warn_network:'âš ï¸ ÙÙŠ ØªØ­Ø°ÙŠØ±Ø§Øª Ù…Ø­ØªØ§Ø¬Ø© Ù…ØªØ§Ø¨Ø¹Ø©',
        crit_network:'ğŸš¨ ÙÙŠ Ù…Ø´Ø§ÙƒÙ„ Ø­Ø±Ø¬Ø© ØªØ­ØªØ§Ø¬ ØªØ¯Ø®Ù„ ÙÙˆØ±ÙŠ!',
        last_updated:'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:', no_data:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª',
        chart_sev:'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª', chart_topics:'Ø£ÙƒØ«Ø± Ø§Ù„Ù…ØµØ§Ø¯Ø±', chart_iface:'Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ±ÙÙŠØ³Ø§Øª',
    },
    en: {
        logo_sub:'Local MikroTik Analyzer â€” Run it from your device',
        not_connected:'Not Connected', connected:'Connected',
        connect_title:'Connect to Router', connect_sub:'Enter router credentials and click Connect',
        lbl_ip:'Router IP', lbl_user:'Username', lbl_pass:'Password',
        btn_connect:'Connect', btn_disconnect:'Disconnect', btn_refresh:'Refresh',
        setup_hint:'Make sure www service is enabled:',
        ps_system:'âš™ï¸ System', ps_iface:'ğŸŒ Interfaces', ps_users:'ğŸ‘¥ Users', ps_logs:'ğŸ“‹ Logs', ps_fw:'ğŸ”¥ Firewall',
        tab_overview:'Overview', tab_iface:'Interfaces', tab_users:'Users', tab_logs:'Logs', tab_fw:'Firewall', tab_ip:'IP Addresses',
        iface_title:'Interfaces', hs_users_title:'Hotspot Users', ppp_users_title:'PPP/VPN Users',
        dhcp_title:'DHCP Leases', logs_title:'Detailed Logs',
        fw_filter_title:'Firewall Rules', fw_nat_title:'NAT Rules',
        ip_addr_title:'IP Addresses', routes_title:'Routing Table',
        all_levels:'All Levels', all_topics:'All Sources',
        stat_cpu:'CPU', stat_mem:'Memory', stat_disk:'Disk',
        stat_uptime:'Uptime', stat_version:'Version', stat_board:'Board',
        stat_hs:'Hotspot', stat_ppp:'PPP/VPN', stat_dhcp:'DHCP',
        stat_fw_rules:'FW Rules', stat_total_logs:'Total Logs',
        stat_errors:'Errors', stat_warnings:'Warnings',
        iface_name:'Name', iface_type:'Type', iface_status:'Status',
        iface_rx:'RX', iface_tx:'TX', iface_mac:'MAC',
        hs_user:'User', hs_ip:'IP', hs_mac:'MAC', hs_uptime:'Uptime',
        hs_rx:'RX', hs_tx:'TX',
        log_time:'Time', log_level:'Level', log_src:'Source', log_msg:'Message',
        fw_chain:'Chain', fw_action:'Action', fw_src:'Source', fw_dst:'Destination',
        fw_proto:'Protocol', fw_comment:'Comment',
        ip_addr:'Address', ip_iface:'Interface', ip_network:'Network',
        route_dst:'Destination', route_gw:'Gateway', route_iface:'Interface', route_dist:'Distance',
        err_timeout:'Connection timeout â€” check IP and network',
        err_auth:'Wrong username or password',
        err_cors:'Make sure you open the file as file:// not from a server',
        err_service:'www service not enabled â€” run: /ip service enable www',
        err_generic:'Connection error',
        status_connecting:'Connecting...', status_fetching:'Fetching data...',
        status_success:'Connected successfully âœ…', status_disconnected:'Disconnected',
        good_network:'âœ… Network healthy â€” no major issues',
        warn_network:'âš ï¸ Some warnings need monitoring',
        crit_network:'ğŸš¨ Critical issues need immediate attention!',
        last_updated:'Last updated:', no_data:'No data available',
        chart_sev:'Log Distribution', chart_topics:'Top Sources', chart_iface:'Interface Status',
    }
};

function t(key) { return T[currentLang][key] || key; }

function applyLang() {
    document.documentElement.setAttribute('lang', currentLang);
    document.documentElement.setAttribute('dir', currentLang==='ar'?'rtl':'ltr');
    document.body.className = currentLang==='ar' ? 'ar rtl' : 'en ltr';
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if(T[currentLang][key]) el.textContent = T[currentLang][key];
    });
}

function toggleLang() {
    currentLang = currentLang==='ar'?'en':'ar';
    localStorage.setItem('mtLang', currentLang);
    applyLang();
}

// =====================================================
//  API HELPERS
// =====================================================
function b64(str) { return btoa(unescape(encodeURIComponent(str))); }

async function apiFetch(endpoint, timeout=8000) {
    const url = `http://${CFG.ip}/rest${endpoint}`;
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), timeout);
    try {
        const res = await fetch(url, {
            headers: { 'Authorization': 'Basic ' + b64(`${CFG.user}:${CFG.pass}`) },
            signal: controller.signal
        });
        clearTimeout(timer);
        if(res.status === 401) throw {type:'auth'};
        if(!res.ok) throw {type:'http', status:res.status};
        return await res.json();
    } catch(e) {
        clearTimeout(timer);
        if(e.name==='AbortError') throw {type:'timeout'};
        if(e.type) throw e;
        throw {type:'network', msg:e.message};
    }
}

// Try endpoint, return [] if 404 (not available on this version)
async function tryFetch(endpoint) {
    try { return await apiFetch(endpoint); }
    catch(e) { return []; }
}

// =====================================================
//  CONNECT / DISCONNECT
// =====================================================
async function doConnect() {
    CFG.ip   = document.getElementById('fIP').value.trim();
    CFG.user = document.getElementById('fUser').value.trim();
    CFG.pass = document.getElementById('fPass').value;

    if(!CFG.ip || !CFG.user) { showStatus('error', 'âš ï¸ ' + (currentLang==='ar'?'Ø§Ø¯Ø®Ù„ IP ÙˆØ§Ù„ÙŠÙˆØ²Ø±':'Enter IP and username')); return; }

    const btn = document.getElementById('btnConnect');
    btn.disabled = true;
    btn.innerHTML = `<span class="spin"><i class="fas fa-circle-notch"></i></span> <span>${t('status_connecting')}</span>`;
    showStatus('connecting', '<i class="fas fa-circle-notch spin" style="margin-left:8px;"></i> ' + t('status_connecting'));
    showProgress(true);

    try {
        // Test connection first
        const sysInfo = await apiFetch('/system/resource');
        DATA.system = sysInfo;
        stepDone(1);

        showStatus('connecting', '<i class="fas fa-circle-notch spin" style="margin-left:8px;"></i> ' + t('status_fetching'));

        // Fetch all data
        setProgress(20);
        DATA.interfaces = await tryFetch('/interface');
        stepDone(2); setProgress(40);

        const [hsActive, pppActive, dhcpLeases] = await Promise.all([
            tryFetch('/ip/hotspot/active'),
            tryFetch('/ppp/active'),
            tryFetch('/ip/dhcp-server/lease')
        ]);
        DATA.hsActive = hsActive;
        DATA.pppActive = pppActive;
        DATA.dhcpLeases = dhcpLeases;
        stepDone(3); setProgress(60);

        DATA.logs = await tryFetch('/log');
        stepDone(4); setProgress(80);

        const [fwFilter, fwNat] = await Promise.all([
            tryFetch('/ip/firewall/filter'),
            tryFetch('/ip/firewall/nat')
        ]);
        DATA.fwFilter = fwFilter;
        DATA.fwNat = fwNat;
        stepDone(5); setProgress(100);

        // IP & routes
        const [ipAddresses, routes] = await Promise.all([
            tryFetch('/ip/address'),
            tryFetch('/ip/route')
        ]);
        DATA.ipAddresses = ipAddresses;
        DATA.routes = routes;

        // Identity
        try { const id = await apiFetch('/system/identity'); DATA.identity = id.name || CFG.ip; }
        catch { DATA.identity = CFG.ip; }

        // Done
        setTimeout(() => {
            showProgress(false);
            showStatus('success', '<i class="fas fa-check-circle" style="margin-left:8px;"></i> ' + t('status_success'));
            setConnected(true);
            buildDashboard();
        }, 400);

    } catch(e) {
        showProgress(false);
        let msg = t('err_generic');
        if(e.type==='auth') msg = 'âŒ ' + t('err_auth');
        else if(e.type==='timeout') msg = 'âŒ ' + t('err_timeout');
        else if(e.type==='network') {
            if(e.msg && e.msg.includes('fetch')) msg = 'âŒ ' + t('err_service');
            else msg = 'âŒ ' + t('err_cors');
        }
        showStatus('error', msg);
        btn.disabled = false;
        btn.innerHTML = `<i class="fas fa-bolt"></i> <span>${t('btn_connect')}</span>`;
    }
}

function doDisconnect() {
    setConnected(false);
    DATA = {};
    document.getElementById('dashboard').style.display = 'none';
    showStatus('connecting', t('status_disconnected'));
    destroyCharts();
}

function setConnected(on) {
    const dot = document.getElementById('connDot');
    const lbl = document.getElementById('connLabel');
    const btnC = document.getElementById('btnConnect');
    const btnD = document.getElementById('btnDisconnect');
    dot.className = 'connection-dot ' + (on?'connected':'');
    lbl.textContent = on ? t('connected') : t('not_connected');
    lbl.style.color = on ? '#10b981' : '#64748b';
    btnC.style.display = on ? 'none' : 'flex';
    btnD.style.display = on ? 'block' : 'none';
    btnC.disabled = false;
    btnC.innerHTML = `<i class="fas fa-bolt"></i> <span>${t('btn_connect')}</span>`;
}

async function refreshAll() {
    const icon = document.getElementById('refreshIcon');
    icon.classList.add('spin');
    try {
        DATA.system     = await apiFetch('/system/resource');
        DATA.interfaces = await tryFetch('/interface');
        DATA.hsActive   = await tryFetch('/ip/hotspot/active');
        DATA.pppActive  = await tryFetch('/ppp/active');
        DATA.dhcpLeases = await tryFetch('/ip/dhcp-server/lease');
        DATA.logs       = await tryFetch('/log');
        DATA.fwFilter   = await tryFetch('/ip/firewall/filter');
        DATA.fwNat      = await tryFetch('/ip/firewall/nat');
        DATA.ipAddresses= await tryFetch('/ip/address');
        DATA.routes     = await tryFetch('/ip/route');
        destroyCharts();
        buildDashboard();
        showToast('âœ… ' + (currentLang==='ar'?'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«':'Refreshed'));
    } catch(e) {
        showToast('âŒ ' + t('err_generic'));
    }
    icon.classList.remove('spin');
}

// =====================================================
//  PROGRESS
// =====================================================
function showProgress(on) {
    document.getElementById('fetchProgress').style.display = on ? 'block' : 'none';
    if(!on) return;
    document.getElementById('progressFill').style.width = '0%';
    ['ps1','ps2','ps3','ps4','ps5'].forEach(id => { document.getElementById(id).className='progress-step'; });
}
function setProgress(pct) { document.getElementById('progressFill').style.width = pct + '%'; }
function stepDone(n) {
    const el = document.getElementById('ps'+n);
    el.classList.add('done');
    if(n < 5) document.getElementById('ps'+(n+1)).classList.add('active');
}

// =====================================================
//  STATUS
// =====================================================
function showStatus(type, msg) {
    const el = document.getElementById('statusBar');
    el.className = 'status-bar ' + type;
    el.innerHTML = msg;
}

// =====================================================
//  BUILD DASHBOARD
// =====================================================
function buildDashboard() {
    const dash = document.getElementById('dashboard');
    dash.style.display = 'block';

    // Router info bar
    const sys = DATA.system || {};
    document.getElementById('routerName').textContent = DATA.identity || CFG.ip;
    document.getElementById('routerVersion').textContent = 'RouterOS ' + (sys.version || '?');
    document.getElementById('routerUptime').textContent = 'Uptime: ' + formatUptime(sys.uptime || '');
    document.getElementById('lastUpdate').textContent = t('last_updated') + ' ' + new Date().toLocaleTimeString();

    buildOverview();
    buildInterfaces();
    buildUsers();
    buildLogs();
    buildFirewall();
    buildIP();

    // Update badges
    document.getElementById('badgeIface').textContent = (DATA.interfaces||[]).length;
    const totalUsers = (DATA.hsActive||[]).length + (DATA.pppActive||[]).length;
    document.getElementById('badgeUsers').textContent = totalUsers;
    document.getElementById('badgeLogs').textContent = (DATA.logs||[]).length;
    document.getElementById('badgeFw').textContent = (DATA.fwFilter||[]).length;
}

// =====================================================
//  OVERVIEW TAB
// =====================================================
function buildOverview() {
    const sys = DATA.system || {};
    const logs = DATA.logs || [];

    const cpuLoad = parseInt(sys['cpu-load']) || 0;
    const memTotal = parseInt(sys['total-memory']) || 1;
    const memFree  = parseInt(sys['free-memory']) || 0;
    const memUsed  = memTotal - memFree;
    const memPct   = Math.round(memUsed/memTotal*100);
    const diskTotal= parseInt(sys['total-hdd-space']) || 1;
    const diskFree = parseInt(sys['free-hdd-space']) || 0;
    const diskPct  = Math.round((diskTotal-diskFree)/diskTotal*100);

    const critCount = logs.filter(l=>getSeverity(l)===4).length;
    const errCount  = logs.filter(l=>getSeverity(l)===3).length;
    const warnCount = logs.filter(l=>getSeverity(l)===2).length;

    // Summary alert
    const alertEl = document.getElementById('summaryAlert');
    if(critCount>0) alertEl.innerHTML = `<div class="summary-alert danger"><i class="fas fa-exclamation-circle fa-lg"></i> ${t('crit_network')} (${critCount})</div>`;
    else if(errCount>0) alertEl.innerHTML = `<div class="summary-alert warning"><i class="fas fa-exclamation-triangle fa-lg"></i> ${t('warn_network')} â€” ${errCount} errors</div>`;
    else alertEl.innerHTML = `<div class="summary-alert good"><i class="fas fa-check-circle fa-lg"></i> ${t('good_network')}</div>`;

    // Stats
    const cpuColor = cpuLoad>80?'red':cpuLoad>50?'yellow':'green';
    const memColor = memPct>80?'red':memPct>60?'yellow':'green';
    const statsEl = document.getElementById('overviewStats');
    statsEl.innerHTML = `
        <div class="stat-box ${cpuColor}">
            <i class="fas fa-microchip fa-2x"></i>
            <div class="stat-val">${cpuLoad}%</div>
            <div class="stat-lbl">${t('stat_cpu')}</div>
            <div class="usage-bar"><div class="usage-fill ${cpuColor}" style="width:${cpuLoad}%"></div></div>
        </div>
        <div class="stat-box ${memColor}">
            <i class="fas fa-memory fa-2x"></i>
            <div class="stat-val">${memPct}%</div>
            <div class="stat-lbl">${t('stat_mem')} (${fmtBytes(memUsed)}/${fmtBytes(memTotal)})</div>
            <div class="usage-bar"><div class="usage-fill ${memColor}" style="width:${memPct}%"></div></div>
        </div>
        <div class="stat-box blue">
            <i class="fas fa-hdd fa-2x"></i>
            <div class="stat-val">${diskPct}%</div>
            <div class="stat-lbl">${t('stat_disk')} (${fmtBytes(diskTotal-diskFree)}/${fmtBytes(diskTotal)})</div>
            <div class="usage-bar"><div class="usage-fill blue" style="background:linear-gradient(90deg,#3b82f6,#2563eb);width:${diskPct}%"></div></div>
        </div>
        <div class="stat-box purple">
            <i class="fas fa-wifi fa-2x"></i>
            <div class="stat-val">${(DATA.hsActive||[]).length}</div>
            <div class="stat-lbl">${t('stat_hs')}</div>
        </div>
        <div class="stat-box blue">
            <i class="fas fa-plug fa-2x"></i>
            <div class="stat-val">${(DATA.pppActive||[]).length}</div>
            <div class="stat-lbl">${t('stat_ppp')}</div>
        </div>
        <div class="stat-box green">
            <i class="fas fa-network-wired fa-2x"></i>
            <div class="stat-val">${(DATA.dhcpLeases||[]).filter(l=>l.status==='bound').length}</div>
            <div class="stat-lbl">${t('stat_dhcp')}</div>
        </div>
        <div class="stat-box yellow">
            <i class="fas fa-fire fa-2x"></i>
            <div class="stat-val">${(DATA.fwFilter||[]).length}</div>
            <div class="stat-lbl">${t('stat_fw_rules')}</div>
        </div>
        <div class="stat-box ${critCount>0?'red':errCount>0?'yellow':'green'}">
            <i class="fas fa-exclamation-triangle fa-2x"></i>
            <div class="stat-val">${errCount+critCount}</div>
            <div class="stat-lbl">${t('stat_errors')}</div>
        </div>
        <div class="stat-box blue">
            <i class="fas fa-scroll fa-2x"></i>
            <div class="stat-val">${logs.length}</div>
            <div class="stat-lbl">${t('stat_total_logs')}</div>
        </div>
    `;

    // Charts
    const chartsEl = document.getElementById('overviewCharts');
    chartsEl.innerHTML = `
        <div class="chart-box"><h5><i class="fas fa-chart-pie"></i>${t('chart_sev')}</h5><div class="chart-wrap"><canvas id="chSev"></canvas></div></div>
        <div class="chart-box"><h5><i class="fas fa-network-wired"></i>${t('chart_iface')}</h5><div class="chart-wrap"><canvas id="chIface"></canvas></div></div>
        <div class="chart-box"><h5><i class="fas fa-chart-bar"></i>${t('chart_topics')}</h5><div class="chart-wrap"><canvas id="chTopics"></canvas></div></div>
    `;
    setTimeout(()=>{
        // Severity pie
        const sCtx = document.getElementById('chSev')?.getContext('2d');
        if(sCtx){
            const crit=logs.filter(l=>getSeverity(l)===4).length;
            const err=logs.filter(l=>getSeverity(l)===3).length;
            const warn=logs.filter(l=>getSeverity(l)===2).length;
            const info=logs.filter(l=>getSeverity(l)===1).length;
            if(charts.sev)charts.sev.destroy();
            charts.sev=new Chart(sCtx,{type:'doughnut',data:{labels:['Critical','Error','Warning','Info'],datasets:[{data:[crit,err,warn,info],backgroundColor:['#ef4444','#f59e0b','#eab308','#3b82f6'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8',font:{size:11}}}}}});
        }
        // Interface status
        const iCtx = document.getElementById('chIface')?.getContext('2d');
        if(iCtx && DATA.interfaces){
            const up=DATA.interfaces.filter(i=>i.running==='true'||i.running===true).length;
            const down=DATA.interfaces.length-up;
            if(charts.iface)charts.iface.destroy();
            charts.iface=new Chart(iCtx,{type:'doughnut',data:{labels:['Up','Down'],datasets:[{data:[up,down],backgroundColor:['#10b981','#ef4444'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8'}}}}});
        }
        // Top topics
        const tCtx = document.getElementById('chTopics')?.getContext('2d');
        if(tCtx && logs.length){
            const topicCount={};
            logs.forEach(l=>{const topic=(l.topics||'system').split(',')[0];topicCount[topic]=(topicCount[topic]||0)+1;});
            const top=Object.entries(topicCount).sort((a,b)=>b[1]-a[1]).slice(0,8);
            if(charts.topics)charts.topics.destroy();
            charts.topics=new Chart(tCtx,{type:'bar',data:{labels:top.map(x=>x[0]),datasets:[{label:'Count',data:top.map(x=>x[1]),backgroundColor:'rgba(99,102,241,0.7)',borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#64748b',font:{size:10}}},y:{ticks:{color:'#64748b'}}}}});
        }
    },100);

    // System info card
    document.getElementById('resourceCard').innerHTML = `
        <div class="card-title"><i class="fas fa-info-circle"></i> ${t('stat_board')} & ${t('stat_version')}</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
            ${infoRow('fa-microchip','Board',sys['board-name']||'â€”')}
            ${infoRow('fa-code-branch','Version',sys['version']||'â€”')}
            ${infoRow('fa-server','Architecture',sys['architecture-name']||'â€”')}
            ${infoRow('fa-clock','Uptime',formatUptime(sys['uptime']||''))}
            ${infoRow('fa-thermometer-half','CPU Count',sys['cpu-count']||'â€”')}
            ${infoRow('fa-memory','Total RAM',fmtBytes(parseInt(sys['total-memory'])||0))}
        </div>
    `;
}

function infoRow(icon, lbl, val) {
    return `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:12px 15px;display:flex;align-items:center;gap:10px;">
        <i class="fas ${icon}" style="color:var(--primary-light);width:20px;"></i>
        <div><div style="color:#64748b;font-size:0.78rem;">${lbl}</div><div style="color:white;font-weight:600;">${val}</div></div>
    </div>`;
}

// =====================================================
//  INTERFACES TAB
// =====================================================
function buildInterfaces() {
    const ifaces = DATA.interfaces || [];
    let html = `<thead><tr>
        <th>${t('iface_name')}</th><th>${t('iface_type')}</th><th>${t('iface_status')}</th>
        <th>${t('iface_rx')}</th><th>${t('iface_tx')}</th><th>${t('iface_mac')}</th>
    </tr></thead><tbody>`;
    ifaces.forEach(i => {
        const running = i.running==='true'||i.running===true;
        const disabled= i.disabled==='true'||i.disabled===true;
        let statusBadge = running ? `<span class="badge badge-green">â–² Up</span>` : `<span class="badge badge-red">â–¼ Down</span>`;
        if(disabled) statusBadge = `<span class="badge badge-yellow">âŠ˜ Disabled</span>`;
        html += `<tr>
            <td style="font-weight:700;color:white;">${i.name||'â€”'}</td>
            <td><span class="badge badge-purple">${i.type||'ether'}</span></td>
            <td>${statusBadge}</td>
            <td style="font-family:monospace;">${fmtBytes(parseInt(i['rx-byte'])||0)}</td>
            <td style="font-family:monospace;">${fmtBytes(parseInt(i['tx-byte'])||0)}</td>
            <td><span class="ip-tag">${i['mac-address']||'â€”'}</span></td>
        </tr>`;
    });
    html += '</tbody>';
    document.getElementById('ifaceTable').innerHTML = html;
}

// =====================================================
//  USERS TAB
// =====================================================
function buildUsers() {
    buildHSTable(DATA.hsActive||[]);
    buildPPPTable(DATA.pppActive||[]);
    buildDHCPTable(DATA.dhcpLeases||[]);
}

function buildHSTable(users) {
    let html = `<thead><tr>
        <th>${t('hs_user')}</th><th>${t('hs_ip')}</th><th>${t('hs_mac')}</th>
        <th>${t('hs_uptime')}</th><th>${t('hs_rx')}</th><th>${t('hs_tx')}</th>
    </tr></thead><tbody>`;
    if(!users.length) html += `<tr><td colspan="6" style="text-align:center;color:#475569;padding:30px;">${t('no_data')}</td></tr>`;
    users.forEach(u => {
        html += `<tr>
            <td style="font-weight:700;color:white;">${u.user||'â€”'}</td>
            <td><span class="ip-tag">${u.address||'â€”'}</span></td>
            <td style="font-family:monospace;font-size:0.8rem;">${u['mac-address']||'â€”'}</td>
            <td>${formatUptime(u.uptime||'')}</td>
            <td>${fmtBytes(parseInt(u['bytes-in'])||0)}</td>
            <td>${fmtBytes(parseInt(u['bytes-out'])||0)}</td>
        </tr>`;
    });
    html += '</tbody>';
    document.getElementById('hsTable').innerHTML = html;
}

function buildPPPTable(users) {
    let html = `<thead><tr><th>${t('hs_user')}</th><th>${t('hs_ip')}</th><th>${t('hs_uptime')}</th><th>Service</th></tr></thead><tbody>`;
    if(!users.length) html += `<tr><td colspan="4" style="text-align:center;color:#475569;padding:30px;">${t('no_data')}</td></tr>`;
    users.forEach(u => {
        html += `<tr>
            <td style="font-weight:700;color:white;">${u.name||'â€”'}</td>
            <td><span class="ip-tag">${u.address||'â€”'}</span></td>
            <td>${formatUptime(u.uptime||'')}</td>
            <td><span class="badge badge-blue">${u.service||'ppp'}</span></td>
        </tr>`;
    });
    html += '</tbody>';
    document.getElementById('pppTable').innerHTML = html;
}

function buildDHCPTable(leases) {
    const active = leases.filter(l=>l.status==='bound');
    let html = `<thead><tr><th>Hostname</th><th>${t('hs_ip')}</th><th>${t('hs_mac')}</th><th>Status</th><th>Expires</th></tr></thead><tbody>`;
    if(!active.length) html += `<tr><td colspan="5" style="text-align:center;color:#475569;padding:30px;">${t('no_data')}</td></tr>`;
    active.forEach(l => {
        html += `<tr>
            <td style="color:white;font-weight:600;">${l['host-name']||'â€”'}</td>
            <td><span class="ip-tag">${l.address||'â€”'}</span></td>
            <td style="font-family:monospace;font-size:0.8rem;">${l['mac-address']||'â€”'}</td>
            <td><span class="badge badge-green">bound</span></td>
            <td style="color:#64748b;font-size:0.85rem;">${l['expires-after']||'â€”'}</td>
        </tr>`;
    });
    html += '</tbody>';
    document.getElementById('dhcpTable').innerHTML = html;
}

window.filterHS = function() {
    const q = document.getElementById('hsSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#hsTable tbody tr');
    rows.forEach(row => { row.style.display = row.textContent.toLowerCase().includes(q)?'':'none'; });
};

// =====================================================
//  LOGS TAB
// =====================================================
let allLogs = [];
function buildLogs() {
    const logs = DATA.logs || [];
    allLogs = logs.map(l => ({
        time: l.time || '',
        topics: l.topics || 'system',
        message: l.message || '',
        severity: getSeverity(l)
    }));

    // Stats
    const crit=allLogs.filter(l=>l.severity===4).length;
    const err=allLogs.filter(l=>l.severity===3).length;
    const warn=allLogs.filter(l=>l.severity===2).length;
    const info=allLogs.filter(l=>l.severity===1).length;
    document.getElementById('logStats').innerHTML = `
        <div class="stat-box red"><i class="fas fa-radiation-alt fa-2x"></i><div class="stat-val">${crit}</div><div class="stat-lbl">Critical</div></div>
        <div class="stat-box yellow"><i class="fas fa-exclamation-triangle fa-2x"></i><div class="stat-val">${err}</div><div class="stat-lbl">Error</div></div>
        <div class="stat-box" style="border-color:rgba(234,179,8,0.2);"><i class="fas fa-exclamation fa-2x" style="color:#eab308;"></i><div class="stat-val" style="color:#eab308;">${warn}</div><div class="stat-lbl">Warning</div></div>
        <div class="stat-box blue"><i class="fas fa-info-circle fa-2x"></i><div class="stat-val">${info}</div><div class="stat-lbl">Info</div></div>
        <div class="stat-box purple"><i class="fas fa-scroll fa-2x"></i><div class="stat-val">${logs.length}</div><div class="stat-lbl">Total</div></div>
    `;

    // Summary
    const logSumEl = document.getElementById('logSummaryAlert');
    if(crit>0) logSumEl.innerHTML=`<div class="summary-alert danger"><i class="fas fa-exclamation-circle fa-lg"></i> ğŸš¨ ${crit} Critical â€” ${t('crit_network')}</div>`;
    else if(err>0) logSumEl.innerHTML=`<div class="summary-alert warning"><i class="fas fa-exclamation-triangle fa-lg"></i> âš ï¸ ${err} Errors</div>`;
    else logSumEl.innerHTML=`<div class="summary-alert good"><i class="fas fa-check-circle fa-lg"></i> ${t('good_network')}</div>`;

    // Topic filter
    const topics=[...new Set(allLogs.map(l=>l.topics.split(',')[0]))].sort();
    const topicSel=document.getElementById('logTopicFilter');
    topicSel.innerHTML=`<option value="all">${t('all_topics')}</option>`;
    topics.forEach(tp=>{ const opt=document.createElement('option'); opt.value=tp; opt.textContent=tp; topicSel.appendChild(opt); });

    // Charts
    const chartsEl = document.getElementById('logCharts');
    chartsEl.innerHTML = `
        <div class="chart-box"><h5><i class="fas fa-chart-line"></i>Timeline</h5><div class="chart-wrap"><canvas id="chLogTime"></canvas></div></div>
        <div class="chart-box"><h5><i class="fas fa-chart-bar"></i>Top Topics</h5><div class="chart-wrap"><canvas id="chLogTopics"></canvas></div></div>
    `;
    setTimeout(()=>{
        // Timeline
        const tCtx=document.getElementById('chLogTime')?.getContext('2d');
        if(tCtx){
            const slots={};
            allLogs.forEach(l=>{const h=l.time.substring(0,2)||'00';slots[h]=(slots[h]||0)+1;});
            const keys=Object.keys(slots).sort();
            if(charts.logTime)charts.logTime.destroy();
            charts.logTime=new Chart(tCtx,{type:'line',data:{labels:keys.map(h=>h+':00'),datasets:[{label:'Logs',data:keys.map(h=>slots[h]),borderColor:'#6366f1',backgroundColor:'rgba(99,102,241,0.15)',tension:0.4,fill:true,pointRadius:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#64748b',font:{size:10}}},y:{ticks:{color:'#64748b'}}}}});
        }
        // Top topics
        const lCtx=document.getElementById('chLogTopics')?.getContext('2d');
        if(lCtx){
            const tc={};allLogs.forEach(l=>{const tp=l.topics.split(',')[0];tc[tp]=(tc[tp]||0)+1;});
            const top=Object.entries(tc).sort((a,b)=>b[1]-a[1]).slice(0,8);
            if(charts.logTopics)charts.logTopics.destroy();
            charts.logTopics=new Chart(lCtx,{type:'bar',data:{labels:top.map(x=>x[0]),datasets:[{data:top.map(x=>x[1]),backgroundColor:['#ef4444','#f59e0b','#8b5cf6','#3b82f6','#10b981','#ec4899','#6366f1','#f97316'],borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#64748b',font:{size:10}}},y:{ticks:{color:'#64748b'}}}}});
        }
    },150);

    renderLogArea(allLogs);
}

function renderLogArea(logs) {
    const el = document.getElementById('logArea');
    if(!logs.length){ el.innerHTML=`<span style="color:#475569;">${t('no_data')}</span>`; return; }
    el.innerHTML = logs.slice(0,500).map(l => {
        const cls = ['','log-info','log-warning','log-error','log-critical'][l.severity]||'log-info';
        const icon = ['','â„¹ï¸','âš ï¸','âŒ','ğŸš¨'][l.severity]||'â„¹ï¸';
        return `<div class="${cls}"><span class="log-time">${l.time}</span><span class="log-source">[${l.topics}]</span> ${icon} ${escHtml(l.message)}</div>`;
    }).join('');
}

window.filterLogs = function() {
    const q   = document.getElementById('logSearch')?.value.toLowerCase()||'';
    const sev = document.getElementById('logSevFilter')?.value||'all';
    const top = document.getElementById('logTopicFilter')?.value||'all';
    const sevMap = {critical:4,error:3,warning:2,info:1};
    const filtered = allLogs.filter(l=>{
        if(sev!=='all' && l.severity!==sevMap[sev]) return false;
        if(top!=='all' && !l.topics.includes(top)) return false;
        if(q && !l.message.toLowerCase().includes(q) && !l.topics.includes(q)) return false;
        return true;
    });
    renderLogArea(filtered);
};

// =====================================================
//  FIREWALL TAB
// =====================================================
function buildFirewall() {
    buildFWTable('fwFilterTable', DATA.fwFilter||[]);
    buildFWTable('fwNatTable', DATA.fwNat||[]);
}
function buildFWTable(id, rules) {
    let html=`<thead><tr><th>#</th><th>${t('fw_chain')}</th><th>${t('fw_action')}</th><th>${t('fw_src')}</th><th>${t('fw_dst')}</th><th>${t('fw_proto')}</th><th>Packets</th><th>${t('fw_comment')}</th></tr></thead><tbody>`;
    if(!rules.length) html+=`<tr><td colspan="8" style="text-align:center;color:#475569;padding:30px;">${t('no_data')}</td></tr>`;
    rules.slice(0,100).forEach((r,i)=>{
        const actionColors={accept:'badge-green',drop:'badge-red',reject:'badge-red',masquerade:'badge-blue',dst_nat:'badge-yellow',src_nat:'badge-yellow'};
        const action=r.action||'â€”';
        html+=`<tr>
            <td style="color:#475569;">${i+1}</td>
            <td><span class="badge badge-purple">${r.chain||'â€”'}</span></td>
            <td><span class="badge ${actionColors[action]||'badge-blue'}">${action}</span></td>
            <td style="font-family:monospace;font-size:0.82rem;">${r['src-address']||r['src-address-list']||'any'}</td>
            <td style="font-family:monospace;font-size:0.82rem;">${r['dst-address']||r['dst-address-list']||'any'}</td>
            <td>${r.protocol||'any'}</td>
            <td style="color:#64748b;">${fmtNum(parseInt(r.packets)||0)}</td>
            <td style="color:#64748b;font-size:0.82rem;">${r.comment||'â€”'}</td>
        </tr>`;
    });
    html+='</tbody>';
    document.getElementById(id).innerHTML=html;
}

// =====================================================
//  IP TAB
// =====================================================
function buildIP() {
    // IP Addresses
    const addrs=DATA.ipAddresses||[];
    let html=`<thead><tr><th>${t('ip_addr')}</th><th>${t('ip_iface')}</th><th>${t('ip_network')}</th><th>Status</th></tr></thead><tbody>`;
    if(!addrs.length) html+=`<tr><td colspan="4" style="text-align:center;color:#475569;padding:30px;">${t('no_data')}</td></tr>`;
    addrs.forEach(a=>{
        const disabled=a.disabled==='true'||a.disabled===true;
        html+=`<tr>
            <td><span class="ip-tag">${a.address||'â€”'}</span></td>
            <td style="font-weight:600;color:white;">${a.interface||'â€”'}</td>
            <td style="color:#64748b;">${a.network||'â€”'}</td>
            <td>${disabled?'<span class="badge badge-yellow">Disabled</span>':'<span class="badge badge-green">Active</span>'}</td>
        </tr>`;
    });
    html+='</tbody>';
    document.getElementById('ipAddrTable').innerHTML=html;

    // Routes
    const routes=DATA.routes||[];
    let rHtml=`<thead><tr><th>${t('route_dst')}</th><th>${t('route_gw')}</th><th>${t('route_iface')}</th><th>${t('route_dist')}</th><th>Status</th></tr></thead><tbody>`;
    if(!routes.length) rHtml+=`<tr><td colspan="5" style="text-align:center;color:#475569;padding:30px;">${t('no_data')}</td></tr>`;
    routes.slice(0,50).forEach(r=>{
        const active=r.active==='true'||r.active===true;
        rHtml+=`<tr>
            <td><span class="ip-tag">${r['dst-address']||'â€”'}</span></td>
            <td style="color:#94a3b8;">${r.gateway||r['gateway']||'â€”'}</td>
            <td style="color:white;">${r.interface||r['routing-mark']||'â€”'}</td>
            <td style="color:#64748b;">${r.distance||'â€”'}</td>
            <td>${active?'<span class="badge badge-green">Active</span>':'<span class="badge badge-yellow">Inactive</span>'}</td>
        </tr>`;
    });
    rHtml+='</tbody>';
    document.getElementById('routesTable').innerHTML=rHtml;
}

// =====================================================
//  TABS
// =====================================================
function showTab(name) {
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('panel-'+name).classList.add('active');
    document.getElementById('tab-'+name).classList.add('active');
}

// =====================================================
//  HELPERS
// =====================================================
function getSeverity(log) {
    const topics = (log.topics||'').toLowerCase();
    const msg = (log.message||'').toLowerCase();
    if(topics.includes('critical')||msg.includes('critical')||topics.includes('error,critical')) return 4;
    if(topics.includes('error')||msg.includes('error')||msg.includes('failed')||msg.includes('failure')) return 3;
    if(topics.includes('warning')||msg.includes('warning')) return 2;
    return 1;
}

function formatUptime(str) {
    if(!str) return 'â€”';
    return str.replace(/(\d+)w/,'$1w ').replace(/(\d+)d/,'$1d ').replace(/(\d+)h/,'$1h ').replace(/(\d+)m/,'$1m ').trim();
}

function fmtBytes(bytes) {
    if(!bytes||bytes===0) return '0 B';
    const k=1024, sizes=['B','KB','MB','GB','TB'];
    const i=Math.floor(Math.log(bytes)/Math.log(k));
    return parseFloat((bytes/Math.pow(k,i)).toFixed(1))+' '+sizes[i];
}

function fmtNum(n) {
    if(n>=1000000) return (n/1000000).toFixed(1)+'M';
    if(n>=1000) return (n/1000).toFixed(1)+'K';
    return n.toString();
}

function escHtml(str) {
    return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function destroyCharts() {
    Object.values(charts).forEach(c=>{ try{c.destroy();}catch{} });
    charts={};
}

function showToast(msg) {
    const t=document.createElement('div');
    t.className='toast';t.textContent=msg;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(),2500);
}

// =====================================================
//  INIT
// =====================================================
applyLang();

// Enter key
['fIP','fUser','fPass'].forEach(id=>{
    document.getElementById(id).addEventListener('keydown',e=>{ if(e.key==='Enter') doConnect(); });
});
</script>
</body>
</html>
